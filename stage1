#!/bin/bash

set -e

export SHELL="/bin/bash"
export LC_ALL=C

export HOME=/usr/local
sudo mkdir -p $HOME
sudo chown 1000:1000 /usr/local

unset LD_LIBRARY_PATH
if [ ! -d /home/runner/work ]; then NTHREADS=$(( $(grep -c processor /proc/cpuinfo) / 4 )); else NTHREADS=4; fi
if [ ${NTHREADS} -lt 1 ]; then NTHREADS=1; fi

curl -L https://gitweb.gentoo.org/repo/proj/prefix.git/plain/scripts/bootstrap-prefix.sh -o /tmp/bootstrap-prefix.sh
sed -i -z 's@sys-devel/patch\n\t\tsys-devel/binutils-config@sys-devel/patch\n\t\tsys-libs/zlib\n\t\tsys-devel/binutils-config@g' /tmp/bootstrap-prefix.sh
chmod 0755 /tmp/bootstrap-prefix.sh

EMERGE_DEFAULT_OPTS="--jobs 2" MAKEOPTS="--jobs ${NTHREADS}" /tmp/bootstrap-prefix.sh /usr/local/gentoo stage1
EMERGE_DEFAULT_OPTS="--jobs 2" MAKEOPTS="--jobs ${NTHREADS}" /tmp/bootstrap-prefix.sh /usr/local/gentoo stage2
echo -e "EMERGE_DEFAULT_OPTS=\"--jobs 2\"\nMAKEOPTS=\"--jobs 4\"\nVIDEO_CARDS=\"\"" > /usr/local/gentoo/etc/portage/make.conf/make.conf
sed -i "s@'-static' '-static-pie' '-fno-PIE -no-pie'@'-static'@g" /usr/local/gentoo/var/db/repos/gentoo/sys-devel/binutils/binutils-*.ebuild
for i in /usr/local/gentoo/var/db/repos/gentoo/sys-devel/binutils/*.ebuild; do j=$(basename $i); sed -i "s@EBUILD $j .*@EBUILD $j $(du -b $i | cut -f1) BLAKE2B $(b2sum $i | cut -d' ' -f1) SHA512 $(sha512sum $i | cut -d' ' -f1)@g" /usr/local/gentoo/var/db/repos/gentoo/sys-devel/binutils/Manifest; done
EMERGE_DEFAULT_OPTS="--jobs 2" MAKEOPTS="--jobs ${NTHREADS}" /tmp/bootstrap-prefix.sh /usr/local/gentoo stage3

EMERGE_DEFAULT_OPTS="--jobs 2" MAKEOPTS="--jobs ${NTHREADS}" /usr/local/gentoo/usr/bin/emerge -uDN @world app-portage/prefix-toolkit
mkdir /usr/local/bin
cp /usr/local/gentoo/startprefix /usr/local/bin/startprefix

#echo -e "EMERGE_DEFAULT_OPTS=\"--jobs 2\"\nMAKEOPTS=\"--jobs 4\"\nUSE=\"alsa dbus gtk harfbuzz -nls opengl openssl pulseaudio text vulkan wayland X\"" > /usr/local/gentoo/etc/portage/make.conf/make.conf
#mkdir -p /usr/local/gentoo/etc/portage/package.use

#EMERGE_DEFAULT_OPTS="--jobs 2" MAKEOPTS="--jobs ${NTHREADS}" /usr/local/gentoo/usr/bin/emerge -uDN @world dev-cpp/gtest media-video/pipewire net-libs/libproxy net-misc/openssh x11-base/xorg-drivers x11-base/xwayland
#ln -s libproxy/libpxbackend-1.0.so /usr/local/gentoo/usr/lib64/

#/usr/local/bin/startprefix <<SOMMELIER
#git clone -b main https://chromium.googlesource.com/chromiumos/platform2.git /tmp/cros_tools
#cd /tmp/cros_tools
#mkdir -p ./vm_tools/sommelier/out
#cd ./vm_tools/sommelier/out
#meson setup -Dprefix=/usr/local/gentoo -Dlibdir=/usr/local/gentoo/usr/lib64 -Dbuildtype=release -Dxwayland_path=/usr/local/gentoo/usr/bin/Xwayland -Dxwayland_gl_driver_path=/usr/local/gentoo/usr/lib64/dri ..
#ninja
#ninja install
#cd /
#rm -rf /tmp/cros_tools
#SOMMELIER

rm -rf /usr/local/gentoo/tmp/* /usr/local/gentoo/var/cache/distfiles/*

echo '' > /usr/local/.finished

